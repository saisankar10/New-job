version: 2.1
jobs:
  Slack_setup:
    machine:
        image: 'ubuntu-1604:201903-01'
    steps:
       - slack/approval:
          message: "Deployment Pending for Approvals 'https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}'" # Optional: Enter your own message
          mentions: "W015C9HCQSH,W01232MH4GM,W016RHZPZ1A" # Optional: Enter the Slack IDs of any user or group (sub_team) to be mentioned
          color: "#42e2f4" # Optional: Assign custom colors for each approval message
          webhook: "$SLACK_WEBHOOK" # Optional: Enter a specific webhook here or the default will use $SLACK_WEBHOOK
          url: 'https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}'
  Level2_Approvals:
    machine:
        image: 'ubuntu-1604:201903-01'
    steps:
       - slack/approval:
          message: "Deployment Pending for Approvals level2 'https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}'" # Optional: Enter your own message
          mentions: "sai.sankar@crypto.com" # Optional: Enter the Slack IDs of any user or group (sub_team) to be mentioned
          color: "#42e2f4" # Optional: Assign custom colors for each approval message
          webhook: "$SLACK_WEBHOOK" # Optional: Enter a specific webhook here or the default will use $SLACK_WEBHOOK
          url: 'https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}'
  Level3_Approvals:
    machine:
        image: 'ubuntu-1604:201903-01'
    steps:
       - slack/approval:
          message: "Deployment Pending for Approvals Level3 'https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}'" # Optional: Enter your own message
          mentions: "sai.sankar@crypto.com" # Optional: Enter the Slack IDs of any user or group (sub_team) to be mentioned
          color: "#42e2f4" # Optional: Assign custom colors for each approval message
          webhook: "$SLACK_WEBHOOK" # Optional: Enter a specific webhook here or the default will use $SLACK_WEBHOOK
          url: 'https://circleci.com/workflow-run/${CIRCLE_WORKFLOW_ID}'
      
    
  Publish_Npm_registry:
    machine:
      image: 'ubuntu-1604:201903-01'
    steps:
      - run: echo "Install Jfrog CLI"
      - run: curl -fL https://getcli.jfrog.io | sh
      - run: ./jfrog rt config --url $ARTIFACTORY_URL --user $ARTIFACTORY_USER --password $ARTIFACTORY_PASSWORD --interactive=false
      - run: ./jfrog rt dl "build-artifacts" "Demo-npm-local" --build-name=JCircleCI-Demo --build-number=$CIRCLE_BUILD_NUM --flat=true
      - run: ./jfrog rt c show
      - run: ./jfrog rt bce JCircleCI-Demo $CIRCLE_BUILD_NUM
      - run: ./jfrog rt bp JCircleCI-Demo $CIRCLE_BUILD_NUM
      - run: ./jfrog rt bpr JCircleCI-Demo $CIRCLE_BUILD_NUM npm-demo-registry
      - slack/notify:
          message: "Deployment was successful. Artifacts successfully pushed to NPM registry" # Optional: Enter your own message
          mentions: "sai.sankar@crypto.com" # Optional: Enter the Slack IDs of any user or group (sub_team) to be mentioned
          color: "#42e2f4" # Optional: Assign custom colors for each approval message
          webhook: "$SLACK_WEBHOOK" # Optional: Enter a specific webhook here or the default will use $SLACK_WEBHOOK
orbs:
  slack: circleci/slack@3.4.2
workflows:
  your-workflow:
    jobs:
      - Slack_setup
      - hold:
            type: approval
            requires:
              - Slack_setup
      - Level2_Approvals:
            requires:
              - hold
      - hold2:
            type: approval
            requires: 
              - Level2_Approvals              
      - Level3_Approvals:
            requires:
              - hold2
      - hold3:
            type: approval
            requires:
              - Level3_Approvals
      - Publish_Npm_registry:
            requires:
            - hold3
      
